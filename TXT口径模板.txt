《统一通用口径：TXT口径模板（唯一母版对齐｜winner=diff_sign｜DUAL_SEEN｜RAW/ENTRY/🎯/📌）》

目标：

【版本水印（交付验收用｜锁死）】

水印：🚀🚀🚀 🍔🍔🍔 🎰🎰🎰

交付首屏必须原样打印以上水印；缺失=默认串台/旧版本=直接作废。

【对外术语（锁死）】
- 对外只用：⭐ / 投放点 / 执行阶段 / 结算阶段。
- ♻ / 🎯 / 📌 / RAW / ENTRY 仅为打印定位符（内部字段），不得作为对外定义词。

【旧统计块黑名单（交付验收｜一票否决）】

- 只要交付输出中出现任一关键词：博弈向= / 同向= / 均差方向
  → 视为沿用旧“均差方向”统计块，判【口径污染】→ 直接作废。

【必出输出块标题（交付验收｜锁死）】

- 交付报告中必须出现以下标题（原样可检索）：
[锁死标题] L1点差分布（投放点｜|点差|=0..9 + 9+）
[锁死标题] L1变化率分桶（投放点｜前小/前大/极值/无效）
[锁死标题] L1均差分桶（投放点｜有效同向/有效反向/中轴）
[锁死标题] L2变化率分桶（注位快照｜减速/加速/极值/无效）
[锁死标题] L2均差绝对值分桶（注位快照｜<3/≥3）
[锁死标题] L2点差分布（注位快照｜|点差|=1..9；纠错=0与9+）
[锁死标题] L3变化率分桶（注位快照｜减速/加速/极值/无效）
[锁死标题] L3均差绝对值分桶（注位快照｜<3/≥3）
[锁死标题] L3点差分布（注位快照｜|点差|=1..9；纠错=0与9+）
[锁死标题] L4变化率分桶（注位快照｜减速/加速/极值/无效）
[锁死标题] L4均差绝对值分桶（注位快照｜<3/≥3）
[锁死标题] L4点差分布（注位快照｜|点差|=1..9；纠错=0与9+）

（仅当 SNAP_PROFILE 含 L5 或 目标层=L5 时，额外必出）
[锁死标题] L5变化率分布（注位快照｜减速/加速/极值/无效）
[锁死标题] L5均差分布（注位快照｜|均差|<3 vs >=3｜mean=0）
[锁死标题] L5点差分布（注位快照｜|点差|=1..9；纠错=0与9+）

说明（锁死）：
- 对外术语：只用 ⭐/投放点/执行阶段/结算阶段；♻/🎯/📌/RAW/ENTRY 仅作打印定位符。
- L1变化率桶名锁死：前小/前大/极值/无效。
- L2-L4变化率桶名锁死：减速/加速/极值/无效。
- L1均差桶名锁死：有效同向/有效反向/中轴。
- L2-L4均差桶名锁死：均差绝对值 <3 / ≥3（无效另计）。

缺任一标题：视为未按骨架输出 → 直接作废。

【交付模板（锁死｜统一）】

交付物：单个TXT文档（TXT内包含可直接运行的完整Python代码）。

使用方式：复制TXT内容→粘贴到任意 .py 文件→放在CSV数据目录运行。

数据读取：只读取当前目录全部 .csv；自动识别列名；只读不算（禁止重算/推导/窗口/rolling）。
【物理表头字典（锁死｜唯一真源）】
【推荐标准表头（你的数据实况）】Batch｜Sub-Batch｜局号｜PP｜BB｜结果列(可选)｜点差｜变化率｜均差｜靴结束
说明：Batch/局号/PP/BB=只读标签；靴边界只认 Sub-Batch + 靴结束。
必须字段（自动识别的唯一来源）：
- 靴号列：Sub-Batch / 子批次 / 子靴号
- 靴结束列：靴结束 / shoe_end
- 结果列：结果列(可选) / 结果 / Result / r / 匹配项 / res
- 点差列：点差 / diff
- 变化率列：变化率 / rate（允许为空；字符串 "None" 视为无效）
- 均差列：均差 / mean（允许为空；字符串 "None" 视为无效）

允许存在但不作为识别与分组边界（只读标签，不参与靴级判定）：
- Batch / 批次（仅标签）
- 局号
- BB / PP


依赖限制：禁止依赖脚本名称定位；禁止分文件工程；禁止读取任何外部配置/资源/模板文件。

写入限制：运行过程中禁止创建/写入任何新文件或目录（含日志/缓存/输出/中间文件）。

输出规范：控制台打印固定报告块；首屏必须打印“监测开关=开/关”；进度每处理10个CSV文件输出1行。
- 动态水印挂载：除了首屏报告必须打印水印外，引擎在窗口内的每一轮对话交互，均须以“水印组”作为回复开端，确认为当前母版激活状态。

可变范围：用户不做任何代码修改；凡涉及代码变更，一律由执行窗口直接交付“可直接运行的完整代码TXT全文”；禁止要求用户定位/替换/改几行。

这份口径作为“底层通用规则”，覆盖过去与未来所有结构模型。

任意策略只需要在 run_strategy_on_boot(records) 内写“结构/过滤/投放”，其余不改。

============================== 0）核心术语（必须锁死）
结果 r：只允许 'P' / 'B' / 'T'

映射：PP→P，BB→B，和→T

点差 diff：int（原始读取，不重算）

变化率 rate：float 或 None（原始读取，不计算）

均差 mean：float 或 None（原始读取，不计算）
============================== 1）物理表头字典（锁死）

【全局结论口径锁死】
结论前缀：建议使用“结论：”、“审计结果：”或“执行判定：”作为回复起点。
物理排序：结论占位 100% 权重，逻辑解释不得干扰结论的置顶位置。
【口位术语（必须锁死）】
对外讨论与口径只承认三个名词：♻⭐ / 🎯 / 📌。

- ♻⭐：结构扫描结束口（结构定位口）；不等同取值/下注。
- 🎯（N_prebet）：实际取值/下注点（人类取值点）；允许读取该行与历史的点差/变化率/均差（胜方以diff符号为准，不使用结果列判胜方）。
- 📌：抽样定位点；📌=🎯(N_prebet)；只打印：📌|f=文件名|SB=Sub-Batch|N=...（仅三字段）。
- 📌不再绑定 RAW（结构⭐打印字段）；结构核对由人工回表完成（减少打印与混乱）。

其他口位均属于程序内部推进与结算阶段：不命名、不输出、不进入人类演练口径。

============================== 累计口径统一（锁死）
- 结构表 min_len/max_len：一律按 RUNLEN（连续同侧有效口段长）理解。
- 强弱锁定（S/W）：按“有效口累计计数 max(cntB,cntP) 首次>=3”锁定（不要求连续）。
- 禁止：单一计数器混用禁区与段长；必须拆 seen_shift/seen_eff。

============================== 靴完整性硬闸门（Sub-Batch + 靴结束｜锁死）
物理对标：1 靴 ≡ 1 Sub-Batch 的连续行区间；该区间仅最后一行允许“靴结束=1”，其余行必须为 0。

一致性（锁死｜A3）：
- 若 Sub-Batch 发生变化，但上一行未出现“靴结束=1” → 直接报错并打印：文件|Sub-Batch|idx
- 若 出现“靴结束=1”，但下一行仍为同一 Sub-Batch（且非文件结束） → 直接报错并打印：文件|Sub-Batch|idx
- 若 任一靴内出现多次“靴结束=1” → 直接报错并打印：文件|Sub-Batch|idx

============================== 靴级闸门（前(N-1)口禁下注｜锁死）
靴级只定义“🎯（N_prebet：实际取值/下注点）是否允许发生在前(N-1)口”，不影响结构扫描（♻⭐）。
BOOT_FILTER 文案（锁死）：BOOT_FILTER 只影响 ENTRY，不影响 RAW；禁区命中=原位作废+回step1重置+找下一次结构完整命中（非顺延）。

开关（锁死｜必须带✅⛔）：
- BOOT_FILTER=ON✅(禁区 seen_shift=1..(N-1))
- BOOT_FILTER=OFF⛔(靴首允许下注)

seen_shift（锁死）：
- B/P/T 都算一口；用于判定“♻⭐是否落禁区”以及“🎯是否落禁区”。

禁区♻⭐处理策略（冻结区真源｜锁死｜非顺延）：
- 当 BOOT_FILTER=ON 且 命中 ♻⭐ 的 seen_shift ∈ {1..8}：
  - forbidden_action=SKIP_STAR：跳过该♻⭐，继续在同一靴寻找下一颗♻⭐（这是“换事件”，不是把同一颗顺延）。
  - forbidden_action=ABORT_BOOT：作废整靴（不再寻找下一颗♻⭐）。
- 当 BOOT_FILTER=OFF：禁区不拦截（允许该♻⭐进入后续流程）。

靴级违规（硬闸门｜锁死）：
- 若发生任何一次 🎯（N_prebet） 的 seen_shift ∈ {1..8}：
  - BET_IN_FORBIDDEN_SEEN += 1
  - 只打印首次命中一条证据：文件|Sub-Batch|idx
  - 立即报错中断（不得继续后续链路）

靴级自证输出（锁死｜至少三项）：
- TOTAL_BOOT
- BOOT_FILTER=ON✅(禁区 seen_shift=1..(N-1)) 或 BOOT_FILTER=OFF⛔(靴首允许下注)
- forbidden_action=SKIP_STAR 或 forbidden_action=ABORT_BOOT（仅当 BOOT_FILTER=ON 时有意义）

============================== 扫描起点与一次性锁死（永久硬规则）
扫描起点（锁死）：

扫描从“靴首第一行”开始（严格零未来）。

seen_shift：B/P/T 都算一口；用于靴内口数标记（靴级只约束下注）。

交易闸门（锁死｜仅靴级）：见上文“靴级闸门（前(N-1)口禁下注）”。

扫描方式（锁死）：

只允许：一次性扫描

禁用：持续扫描

禁用：一次性扫描+持续扫描

每靴最多1次执行：一旦出现首个合法🎯(N_prebet)并结束（过滤失败/观察终止/激活失败/匹配达成/阈值击穿止）→ 立即结束本靴。


============================== 结构扫描闸门（STRUCT_SCAN｜锁死｜与靴级分离）
结构扫描与靴级闸门分离：
- 结构扫描：从靴首开始逐口扫描，负责“是否存在♻⭐/🎯(候选)”。
- 靴级闸门（BOOT_FILTER）：只拦截“实际落注”是否允许发生在 seen_shift=1..(N-1)；不影响结构扫描。

结构开关（锁死｜必须带✅⛔）：
- STRUCT_SCAN=ON✅（启用结构扫描；必须走唯一入口 scan_structure）
- STRUCT_SCAN=OFF⛔（仅用于自证；本次运行禁止产生/使用任何♻⭐/🎯）

结构摘要（验收一票否决｜锁死｜每次运行必打印1次）：
结构摘要：S≥3 → W1-2 → S⭐ | HASH=<由结构配置表计算得到>

结构名（验收锁死｜每次运行必打印1次）：
结构名：<最终结构名>

HASH变化规则（锁死）：切换结构名（锚点002 STRUCT_NAME_OVERRIDE 或锚点001 ACTIVE_STRUCT_NAME）→ HASH 必变化；仅改锚点002其他参数（不改结构名）→ HASH 不应变化。

缺失该行：立即报错中断（作废）。

结构入口物理锁（锁死）：
- 唯一入口函数名：scan_structure(records)
- 禁止绕路：任何结构扫描不得在其他位置重复实现/判断。

锚点001结构插槽（结构唯一真源｜内部维护｜写手禁区｜锁死口径）：
- 锚点001内部维护三件套：STRUCT_VARIANTS（结构库）/ ACTIVE_STRUCT_NAME（结构名选择器）/ STRUCT_CONFIG_TEXT（运行时唯一输入表）。
- 写手/策略官：不得改锚点001任何内容；不得在锚点002或其他位置写 STRUCT_VARIANTS / ACTIVE_STRUCT_NAME / STRUCT_CONFIG_TEXT（防串台）。
- 结构切换（默认不碰锚点001）：写手在锚点002填写 STRUCT_NAME_OVERRIDE（字符串；必须是 STRUCT_VARIANTS 的 key）；为空则沿用锚点001的 ACTIVE_STRUCT_NAME（仅内部维护）。STRUCT_CONFIG_TEXT 必须由结构库取值生成。
- 执行/快照链路选择：写手在锚点002填写 EXEC_PROFILE_OVERRIDE / SNAP_PROFILE_OVERRIDE（字符串）；为空则使用默认（EXEC=MARTIN_1248；SNAP=L4_ONLY；最高层默认=L4）。
  - EXEC 可选：MARTIN_1248 / MARTIN_124 / MARTIN_124816 / FLAT_1 / WINPRESS_1_1_1p5
  - SNAP 可选：L4_ONLY / L5_ONLY / L4_L5 / ALL_ON / ALL_ON_L5 / L1_ONLY / L1_L4
- L5：逻辑与 L4 一致；仅当 SNAP_PROFILE 含 L5 或 目标层=L5 时启用并输出 L5 标题块。
- 靴级阈值：写手在锚点002填写 BOOT_BLOCK_N_OVERRIDE（靴级别｜字符串数字；0=关闭；>=3启用；空=默认9）。
- 冻结区提供“配置驱动扫描器”解析 STRUCT_CONFIG_TEXT 并执行扫描；锚点001覆盖区禁止自写扫描算法（发现即作废/raise）。
- 覆盖区硬审计（母版自检）：锚点001内（含注释/字符串）不得出现 continue / for / while / BOOT_FILTER / seen_all / range( 等片段。
- 默认结构（可直接作为 STRUCT_CONFIG_TEXT）：
  step	side	min_len	max_len	mark
  1	S	3	999	
  2	W	1	2	
  3	S	1	999	⭐
- 说明（锁死）：
  - min_len/max_len 为段长范围；max_len=999 表示“不封顶”。
  - mark=⭐ 表示“结构结束口”（♻⭐）；不等同 🎯。

- 返回协议（锁死四元组）：
  (status, star_idx, star_side, fail_reason)
  - status ∈ {STRUCT_OK, STRUCT_FAIL}
  - star_idx：♻⭐（结构扫描结束口）所在行索引；失败为 None
  - star_side：本例固定为 'S'；失败为 None
  - fail_reason：失败原因字符串（供雷达自证）

结构合法性（硬闸门｜锁死）：
- ⭐所在行结果必须为 B 或 P（绝不能为 T）。
- ⭐所在行原始点差必须 ≠ 0（点差=0视同T：非法）。
- 发现非法⭐（⭐落T或点差=0）：必须打印一次证据并立即中断整次运行：
  证据字段：文件|Sub-Batch|idx

结构计数口径（段长｜锁死｜禁止跨段累计）：
- 只记录 B/P；T 与 点差=0 永远不参与结构累计：
  - 不打断段长
  - 不参与累计
  - 不可成为⭐
- S/W 判定（锁死）：
  - S：本靴中“第一个达到段长≥3”的一方（B 或 P）
  - W：另一方

本例结构（Q1示例｜锁死为本次STRUCT_TRIGGER_DEF）：
- 目标：S≥3 → W 段长累计 1~2 → S⭐（打S）
- ⭐定位（锁死）：
  - 在 S 已确定后：当出现“紧接着的 W 段长累计为 1 或 2”时
  - 其后的首个 S（且diff≠0（winner_side∈{B,P}））所在行即为⭐

投放可用性（与靴级联动｜锁死）：
- 当 BOOT_FILTER=ON 且 ♻⭐ 落在 seen_shift=1..(N-1)：
  - forbidden_action=SKIP_STAR：允许记录（候选♻⭐），原位作废计数+回step1重置，继续扫描寻找下一次结构完整命中♻⭐（严禁顺延）。
  - forbidden_action=ABORT_BOOT：允许记录（候选♻⭐），并立即 STRUCT_FAIL（作废整靴）。
- 当 ♻⭐ 落在 seen_shift≥min_seen：该♻⭐为“可投放♻⭐”，返回 STRUCT_OK。

结构失败（锁死）：
- 当 S 已确定后，若 W 段长累计达到 ≥3 且尚未找到“可投放⭐”：
  -> 立即判 STRUCT_FAIL，并停止本靴结构扫描，进入下一靴。

结构自证输出（首屏必打｜精简锁死）：
- BUILD_TAG
- winner=diff_sign
- seen_shift=BOOT_FILTER(禁区1..8)
- seen_eff=RUNLEN
- SKIP_STAR => skipped_forbidden_star_cnt + reset_to_step1_cnt
  - STAR_CANDIDATE_FOUND_TOTAL（含前(N-1)口候选⭐）
  - STAR_DEPLOYABLE_FOUND（seen_shift≥9 的可投放⭐）

【通用神谕审计接口（入口门禁）】

审计时机：固定在结构激活后的 🎯(N_prebet)（idx）。

审计职能：读取该行原始指标，由策略决定是否准入。

物理锁死：若审计输出为“不准入”，程序必须放弃本次执行，并立即寻找该靴内下一个合法结构。

============================================================ 【三口分离（写死）｜指标读取硬闸门（写死）｜自证输出（硬注入验证）】

三口分离（写死）：
- ♻⭐：结构扫描结束口（定位口）；不等同 🎯(N_prebet)；结构扫描阶段只允许读取结果 r 与 diff（用于过滤 T/点差=0），禁止读取 rate/mean。
- 🎯(N_prebet)：唯一允许“决策/取值/归因”的口位；允许读取该行与历史的 点差/变化率/均差/结果；本口不执行投放推进。
- 程序内部执行阶段：🎯(N_prebet)的下一行（由 J 游标逐行推进得到；不跳状态T；严禁 idx+偏移量直算）；从此处开始执行投放推进；严禁读取 点差/变化率/均差，只允许读取结果用于结算与推进。
- 程序内部结算阶段：从程序内部执行阶段开始的结算过程；状态T=0退回不推进，直到第一口非状态T完成有效结算；严禁读取 点差/变化率/均差，只允许读取结果。

指标读取硬闸门（写死｜A+B）：
- A）指标读取门禁：仅允许在🎯(N_prebet)读取 点差/变化率/均差；非🎯(N_prebet)触碰任一指标字段=违规阻断。
- B）阶段状态机：扫描/决策/执行/结算分档；执行/结算阶段触碰任一指标字段=违规阻断。
- 违规处理（写死）：一旦触发，必须立刻打印“硬闸门触发=是｜阶段=执行或结算｜原因=非法指标读取”，并立即放弃本靴执行（计入违规次数）。

自证输出（硬注入验证｜写死）：
- 首屏必须额外输出一段“硬闸门自证块”，至少包含：取值口=🎯(N_prebet)；执行阶段指标访问=禁止；结算阶段指标访问=禁止；硬注入验证=通过或失败。
- 硬注入验证定义：引擎启动后必须进行一次“非法指标访问模拟”，确认门禁可阻断；若未阻断，直接打印“不通过：硬闸门失效”，并终止运行。

“多次决策”仅指：同一笔交易内，随着投放量推进（含状态 T 导致的重复投放），在每一次【实际投放前】都允许重新做一次“继续/STOP”的决定。

每一次【实际投放前】的决定时刻，视为一次“🎯(N_prebet)”（决策口）：只允许读取该行及历史的指标与结果；严禁读取该决策口之后（t+1及以后）的任何信息用于决策。

决策之后立即进入“程序内部推进与结算阶段”：只允许读取结果用于结算与推进；禁止读取任何指标（点差/变化率/均差）。

多次决策不得改变：一次性扫描｜每靴最多1次执行｜靴级闸门（前(N-1)口禁下注）｜段长口径｜自停 等全部锁死规则；仅允许产生“提前止损退出”，并用于路径快照归因统计。

以1-2-4-8为例：每次“实际投放前”的投放决策当下记录一次指标快照。

若遇状态 T 导致同一投放量需要重复投放：每次重复投放前也必须记录一条快照（因此快照条数≥4）。

阈值击穿后归因/分桶统计只允许使用这些快照；禁止阈值击穿后回头读取原始指标解释路径。

【双快照趋势审计协议（通用阻断）】 * 快照源列表：系统必须维护一个 snapshots 列表，存储每次“实际投放前”的指标快照。 

二连对比机制：在执行动态阻断决策时，允许策略对比“当前快照 (idx)”与“上一有效投放前快照 (last_bet_idx)”。 * 指标透明化：口径仅提供：|点差|分桶变化（1..9；纠错：|点差|=0 与 9+ 合并计数）、变化率分桶变化（减速/加速/极值/无效）、均差分桶变化（<3/≥3/无效）等通用物理量的计算接口。

【决策口拦截动作规范】 * 拦截触发：当满足策略设定的阻断条件时，决策口 3/4 必须执行 STOP。 

物理清理：一旦触发 STOP，必须记录“提前止损”并立即结束本靴 (Batch) 扫描。


【连续统计（两指标二连变化）｜锁死】

目标：在“多次决策/路径快照（口径B）”基础上，输出可用于AI分析的【二指标二连变化】分布，用于寻找“STOP 机会”。

输出形态：只输出分布/榜单，不输出任何逐条样本流水（默认零样本）。

【连续统计数据源（锁死）】

连续统计只允许基于“路径快照列表”做事后汇总；禁止在连续统计阶段回读 records/原始行指标。
允许“回读/缓存”只能服务于：阶段快照与报表；读取范围只能到 last_settled_idx；任何决策路径读取三指标一律视为未来数并退出。

STOP 决策（若启用）：只允许使用“当前实际投放前快照 + 历史快照（例如上一快照）”；严禁读取下一次投放前快照用于决定本次是否 STOP。

【变化率 rate（二连口径｜仅用于 L2/L3/L4 各自注位快照）】

取值：L2/L3/L4 各自注位“实际投放前快照”当行原始 rate，只读不算。

分桶（锁死｜中文桶名）：
- 减速：rate < 0
- 加速：0 ≤ rate < 2（含0）
- 极值：rate ≥ 2
- 无效：rate 无法解析/为空/NaN

二连信号（锁死｜只看相邻两次实际投放前快照）：
- 上一快照桶 → 当前快照桶（仅作事后分布/榜单统计）


【均差 mean（二连口径｜仅用于 L2/L3/L4 各自注位快照）】

取值：L2/L3/L4 各自注位“实际投放前快照”当行原始 mean，只读不算。

分桶（锁死）：
- <3：|mean| < 3
- ≥3：|mean| ≥ 3（|mean|=3 归此）
- 无效：mean 无法解析/为空/NaN（仅计数；口径项：MEAN_INVALID_BUG，目标=0）

二连信号（锁死｜只看相邻两次实际投放前快照）：
- 上一快照桶 → 当前快照桶（仅作事后分布/榜单统计）


【二指标二连变化（默认输出两套｜仅用于 L2/L3/L4 快照）】

指标①：|点差|桶（1..9）
- 纠错计数：|点差|=0 与 9+ 合并计数（不进入 1..9 分布）

指标②A：rate 桶（减速 / 加速 / 极值 / 无效）
指标②B：mean 桶（<3 / ≥3 / 无效）

统计（锁死）：
- 按“第 n 次实际投放”分层（含状态 T 导致的重复投放）
- 只输出 TopK 转移榜单（出现次数≥门槛才输出）
- 字段至少包含：出现次数、后续阈值击穿数、后续阈值击穿率


【验真分拆（仅验真阶段）】

允许按文件名排序做50/50确定性分拆；仅验真阶段启用。

首屏取消显示“验真分拆开关：是/否”（不影响分拆本身）。

【旧口径黑名单（两份文档都要写｜出现即退回）】
1. expect S/W/S（三段限制）
2. AFTER_S_DEFINED 才开始计段（截断扫描）
3. seg_len 预填充
4. 以 r/Exhaust 判胜方
5. 单一 seen_all 混用禁区与段长
6. 禁区命中后顺延等待可用口（同一结构尾段拖延）